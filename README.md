As atualizações e correções estão neste código.
A nova função ainda não está 100% pronta — vou continuar trabalhando nela, mas aqui está um protótipo.
